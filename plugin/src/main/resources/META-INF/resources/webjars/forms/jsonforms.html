<form role="form" id="task-form-camunda-json-forms">
  
  <!-- data-app required by vuetify -->
  <div id="json-forms-root" data-app></div>

  <script cam-script type="text/form-script">

    function getParameterByName(name, url)  {
        if (!url) return null;

        let parts = url.split('?');
        if (parts.length > 1) {
            const params = new URLSearchParams('?' + parts[1]);

            return params.get(name);
        }

        return null;
    }

    function isStartForm(camForm){
        return camForm.taskId == null;
    }

    function hideStartFormStartButton(){
        let element = document.querySelector("button[ng-click='startProcessInstance()']");
        if (element) {
            element.classList.add("ng-hide");
        }
    }

    function hideUserTaskFormCompleteButton(){
        let elements = document.getElementsByClassName("form-actions");
        if (elements) {
          _.forEach(elements, element => {
            element.classList.add("ng-hide");
          })
        }
    }

    function showNotification(type, duration, status, message){
        inject(['Notifications', function(Notifications) {
            Notifications.addMessage({
                type: type,
                duration: duration,
                status: status,
                message: message
            });
        }]);
    }

    function onFormChange(jsonFormsChangeEvent) {
        let debug = getParameterByName('debug', camForm.options.formUrl) === 'true';
        if (debug) {
            console.log("Form state changed:" + JSON.stringify(jsonFormsChangeEvent));
        }
    }

    function onFormLoadError(error) {
        showNotification('error', null, "Load Error", `${error}`);
    }

    function onFormSubmitSuccessResponse(response) {
        if (camForm.taskId) {
            angular.element('.task-card').scope().dismissTask();
         } else {
             angular.element('.modal-dialog').scope().$parent.$dismiss();
         }
    }

    function onFormSubmitErrorResponse(response) {
        response.json().then((data) => {
            showNotification('error', null, "Submit Error", `${data.message}`);
        }).catch((error) => {
            showNotification('error', null, "Submit Error", `${response.text}`);
        });
    }

    function onFormSubmitError(error) {
        showNotification('error', null, "Submit Error", `${error}`);
    }

    function onFormSubmitHeadersBuilt(headers) {
        inject(['$http', function($http) {

            const xsrfHeaderName = $http.defaults.xsrfHeaderName;
            const xsrfCookieName = $http.defaults.xsrfCookieName;
            let cookieValue = undefined;
            if (xsrfCookieName) {
                cookieValue = document.cookie.split('; ').find(row => row.startsWith(xsrfCookieName + '=')).split('=')[1];
            }

            if (cookieValue && xsrfHeaderName) {
                headers[xsrfHeaderName] = cookieValue;
            }

        }]);

    }

    camForm.on('form-loaded', function () {
        $scope.options.hideCompleteButton = true

        isStartForm(camForm) ? hideStartFormStartButton() : hideUserTaskFormCompleteButton();

        inject(['Uri', function(Uri) {
            let camundaUrl = Uri.appUri('engine://engine/:engine');

            let locale = (navigator.languages && navigator.languages.length) ? navigator.languages[0] : navigator.userLanguage || navigator.language || navigator.browserLanguage || 'en';

            let root = document.querySelector('#json-forms-root');

            let node = CamundaJsonFormsUtil.createCamundaJsonFormsElement({
                camundaUrl: camundaUrl,
                processDefinitionId: camForm.processDefinitionId,
                formUrl: camForm.options.formUrl,
                taskId: camForm.taskId,
                locale: locale,
                style: '.v-application--wrap { min-height: 0px; }',
                onFormChange: onFormChange,                
                onFormLoadError: onFormLoadError,
                onFormSubmitSuccessResponse: onFormSubmitSuccessResponse,
                onFormSubmitErrorResponse: onFormSubmitErrorResponse,
                onFormSubmitError: onFormSubmitError,
                onFormSubmitHeadersBuilt: onFormSubmitHeadersBuilt,
            });

            root.appendChild(node);
        }]);

    });
  </script>
</form>
